<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SM64 MIPS Disassembler</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@700;900&display=swap');

  :root {
    --bg: #0b0a10;
    --panel: #0f1318;
    --border: #1e2a38;
    --accent: #40e85c;
    --accent2: #f5a623;
    --blue: #4fc3f7;
    --green: #69ff85;
    --muted: #4a5568;
    --text: #c8d6e5;
    --bright: #eaf6ff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.08) 2px, rgba(0,0,0,0.08) 4px);
    pointer-events: none;
    z-index: 999;
  }

  header {
    padding: 24px 32px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 16px;
    background: linear-gradient(180deg, #111520 0%, var(--bg) 100%);
  }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-size: 22px;
    font-weight: 900;
    color: var(--accent);
    letter-spacing: 2px;
    text-shadow: 0 0 20px rgba(232,64,64,0.5);
  }

  .logo span { color: var(--accent2); }

  .subtitle {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .star-icon {
    font-size: 28px;
    filter: drop-shadow(0 0 8px #f5a623);
    animation: spin 8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  main {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    height: calc(100vh - 73px);
  }

  .panel {
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border);
  }

  .panel-header {
    padding: 12px 20px;
    background: #0c1018;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-header .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 6px var(--accent);
  }
  .panel-header .dot.green { background: var(--green); box-shadow: 0 0 6px var(--green); }

  .controls {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    background: var(--panel);
  }

  label {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  input[type="text"] {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--blue);
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    padding: 6px 12px;
    width: 140px;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type="text"]:focus { border-color: var(--accent); }

  button {
    background: var(--accent);
    color: #fff;
    border: none;
    font-family: 'Orbitron', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    padding: 8px 20px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.15s;
    box-shadow: 0 0 12px rgba(232,64,64,0.3);
  }
  button:hover { background: #ff5555; box-shadow: 0 0 20px rgba(232,64,64,0.6); }
  button.clear {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    box-shadow: none;
  }
  button.clear:hover { border-color: var(--muted); color: var(--text); }

  textarea {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    padding: 16px 20px;
    resize: none;
    outline: none;
    line-height: 1.7;
  }
  textarea::placeholder { color: #2a3545; }

  .output-area {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .instr-row {
    display: grid;
    grid-template-columns: 90px 80px 1fr;
    gap: 0;
    padding: 2px 20px;
    font-size: 13px;
    line-height: 1.8;
    transition: background 0.1s;
  }
  .instr-row:hover { background: rgba(255,255,255,0.03); }

  .output-area { user-select: none; }
  .asm-col { user-select: text; }
  .addr { color: var(--muted); }
  .hex-col { color: #3a5068; }
  .mnemonic { color: var(--accent2); font-weight: bold; }
  .reg { color: var(--blue); }
  .imm { color: var(--green); }
  .label-ref { color: var(--accent); }
  .comment { color: #2e4055; }
  .pseudo { color: #c084fc; font-style: italic; }

  .error-row {
    padding: 3px 20px;
    font-size: 13px;
    color: var(--accent);
    opacity: 0.7;
  }

  .stats {
    padding: 10px 20px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    display: flex;
    gap: 24px;
  }
  .stats span { color: var(--text); }

  .example-btns {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    padding: 10px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--panel);
  }
  .example-btn {
    background: transparent;
    border: 1px solid #1e3050;
    color: #3a6090;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    padding: 4px 10px;
    cursor: pointer;
    box-shadow: none;
    letter-spacing: 1px;
    transition: all 0.15s;
    text-transform: none;
  }
  .example-btn:hover { border-color: var(--blue); color: var(--blue); background: transparent; box-shadow: none; }
</style>
</head>
<body>

<header>
  <div class="star-icon">⭐</div>
  <div>
    <div class="logo">SM64 <span>DISASM</span></div>
    <div class="subtitle">MIPS R4300i · Raw Hex Disassembler</div>
  </div>
</header>

<main>
  <!-- INPUT -->
  <div class="panel">
    <div class="panel-header"><div class="dot"></div> RAW HEX INPUT</div>
    <div class="controls">
      <label>Base Addr</label>
      <input type="text" id="baseAddr" value="80246000" maxlength="8" placeholder="80246000">
      <button onclick="disassemble()">DISASM</button>
      <button class="clear" onclick="clearAll()">CLEAR</button>
    </div>
    <div class="example-btns">
      <label style="align-self:center">Examples:</label>
      <button class="example-btn" onclick="loadExample('prologue')">Function Prologue</button>
      <button class="example-btn" onclick="loadExample('branch')">Branch/Loop</button>
      <button class="example-btn" onclick="loadExample('mario')">Mario Physics</button>
    </div>
    <textarea id="hexInput" placeholder="Paste raw hex bytes here...&#10;&#10;Formats accepted:&#10;  27BDFFE0 AFBF001C&#10;  27 BD FF E0 AF BF 00 1C&#10;  0x27BDFFE0 0xAFBF001C&#10;  27bdffe0afbf001c&#10;&#10;4 bytes = 1 instruction"></textarea>
  </div>

  <!-- OUTPUT -->
  <div class="panel" style="border-right:none">
    <div class="panel-header"><div class="dot green"></div> MIPS ASSEMBLY OUTPUT</div>
    <div class="output-area" id="output">
      <div style="padding:40px 20px; color:#2a3a50; font-size:13px; line-height:2">
        // Awaiting input...<br>
        // SM64 uses MIPS R4300i (MIPS III ISA)<br>
        // Big-endian 32-bit instructions<br>
        // Paste hex on the left to begin
      </div>
    </div>
    <div class="stats" id="stats" style="display:none">
      Instructions: <span id="statCount">0</span>
      &nbsp;|&nbsp; Errors: <span id="statErr">0</span>
      &nbsp;|&nbsp; Branches: <span id="statBranch">0</span>
    </div>
  </div>
</main>

<script>
// ─── Register names (MIPS ABI) ───────────────────────────────────────────────
const REGS = [
  'r0','at','v0','v1','a0','a1','a2','a3',
  't0','t1','t2','t3','t4','t5','t6','t7',
  's0','s1','s2','s3','s4','s5','s6','s7',
  't8','t9','k0','k1','gp','sp','fp','ra'
];

const FP_REGS = Array.from({length:32},(_,i)=>`f${i}`);

function r(n){ return `<span class="reg">${REGS[n]}</span>`; }
function fr(n){ return `<span class="reg">f${n}</span>`; }
function imm(n,signed=true){
  let v = signed ? (n<<16>>16) : n;
  let hex = (v>>>0).toString(16).toUpperCase().padStart(4,'0');
  return `<span class="imm">0x${hex}</span>`;
}
function immDec(n,signed=true){
  let v = signed ? (n<<16>>16) : n;
  let hex = signed && v < 0
    ? '-0x' + (-v).toString(16).toUpperCase()
    : '0x' + (v>>>0).toString(16).toUpperCase();
  return `<span class="imm">${hex}</span>`;
}
function addr26(instr,pc){
  let target = ((pc & 0xF0000000) | ((instr & 0x3FFFFFF)<<2))>>>0;
  return `<span class="label-ref">0x${target.toString(16).toUpperCase()}</span>`;
}
function branchTarget(imm16,pc){
  let offset = (imm16<<16>>16);
  let target = (pc + 4 + offset*4)>>>0;
  return `<span class="label-ref">0x${target.toString(16).toUpperCase()}</span>`;
}
function sext16(v){ return (v<<16>>16); }

// ─── Disassemble one 32-bit word ─────────────────────────────────────────────
function disasmWord(word, pc) {
  const op    = (word >>> 26) & 0x3F;
  const rs    = (word >>> 21) & 0x1F;
  const rt    = (word >>> 16) & 0x1F;
  const rd    = (word >>> 11) & 0x1F;
  const sa    = (word >>>  6) & 0x1F;
  const funct =  word         & 0x3F;
  const imm16 =  word         & 0xFFFF;
  const imm26 =  word         & 0x3FFFFFF;

  const mn = (s) => `<span class="mnemonic">${s}</span>`;
  const ps = (s) => `<span class="pseudo">${s}</span>`;

  // ── SPECIAL (op=0) ──────────────────────────────────────────────────────────
  if (op === 0) {
    switch(funct) {
      case 0x00:
        if (word === 0) return `${ps('nop')}`;
        return `${mn('sll')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
      case 0x02: return `${mn('srl')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
      case 0x03: return `${mn('sra')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
      case 0x04: return `${mn('sllv')} ${r(rd)}, ${r(rt)}, ${r(rs)}`;
      case 0x06: return `${mn('srlv')} ${r(rd)}, ${r(rt)}, ${r(rs)}`;
      case 0x07: return `${mn('srav')} ${r(rd)}, ${r(rt)}, ${r(rs)}`;
      case 0x08:
        if (rd === 0) return `${ps('jr')} ${r(rs)}`;
        return `${mn('jr')} ${r(rs)}`;
      case 0x09:
        if (rd === 31) return `${ps('jalr')} ${r(rs)}`;
        return `${mn('jalr')} ${r(rd)}, ${r(rs)}`;
      case 0x0C: return `${mn('syscall')}`;
      case 0x0D: return `${mn('break')}`;
      case 0x0F: return `${mn('sync')}`;
      case 0x10: return `${mn('mfhi')} ${r(rd)}`;
      case 0x11: return `${mn('mthi')} ${r(rs)}`;
      case 0x12: return `${mn('mflo')} ${r(rd)}`;
      case 0x13: return `${mn('mtlo')} ${r(rs)}`;
      case 0x14: return `${mn('dsllv')} ${r(rd)}, ${r(rt)}, ${r(rs)}`;
      case 0x16: return `${mn('dsrlv')} ${r(rd)}, ${r(rt)}, ${r(rs)}`;
      case 0x17: return `${mn('dsrav')} ${r(rd)}, ${r(rt)}, ${r(rs)}`;
      case 0x18: return `${mn('mult')} ${r(rs)}, ${r(rt)}`;
      case 0x19: return `${mn('multu')} ${r(rs)}, ${r(rt)}`;
      case 0x1A: return `${mn('div')} ${r(rs)}, ${r(rt)}`;
      case 0x1B: return `${mn('divu')} ${r(rs)}, ${r(rt)}`;
      case 0x1C: return `${mn('dmult')} ${r(rs)}, ${r(rt)}`;
      case 0x1D: return `${mn('dmultu')} ${r(rs)}, ${r(rt)}`;
      case 0x1E: return `${mn('ddiv')} ${r(rs)}, ${r(rt)}`;
      case 0x1F: return `${mn('ddivu')} ${r(rs)}, ${r(rt)}`;
      case 0x20:
        if (rs === 0) return `${ps('move')} ${r(rd)}, ${r(rt)}`;
        return `${mn('add')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x21:
        if (rs === 0) return `${ps('move')} ${r(rd)}, ${r(rt)}`;
        return `${mn('addu')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x22: return `${mn('sub')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x23: return `${mn('subu')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x24: return `${mn('and')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x25:
        if (rs === 0 && rt === 0) return `${ps('clear')} ${r(rd)}`;
        if (rs === 0) return `${ps('move')} ${r(rd)}, ${r(rt)}`;
        return `${mn('or')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x26: return `${mn('xor')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x27:
        if (rs === 0) return `${ps('not')} ${r(rd)}, ${r(rt)}`;
        return `${mn('nor')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x2A: return `${mn('slt')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x2B: return `${mn('sltu')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x2C: return `${mn('dadd')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x2D: return `${mn('daddu')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x2E: return `${mn('dsub')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x2F: return `${mn('dsubu')} ${r(rd)}, ${r(rs)}, ${r(rt)}`;
      case 0x30: return `${mn('tge')} ${r(rs)}, ${r(rt)}`;
      case 0x31: return `${mn('tgeu')} ${r(rs)}, ${r(rt)}`;
      case 0x32: return `${mn('tlt')} ${r(rs)}, ${r(rt)}`;
      case 0x33: return `${mn('tltu')} ${r(rs)}, ${r(rt)}`;
      case 0x34: return `${mn('teq')} ${r(rs)}, ${r(rt)}`;
      case 0x36: return `${mn('tne')} ${r(rs)}, ${r(rt)}`;
      case 0x38: return `${mn('dsll')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
      case 0x3A: return `${mn('dsrl')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
      case 0x3B: return `${mn('dsra')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
      case 0x3C: return `${mn('dsll32')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
      case 0x3E: return `${mn('dsrl32')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
      case 0x3F: return `${mn('dsra32')} ${r(rd)}, ${r(rt)}, ${immDec(sa,false)}`;
    }
    return null;
  }

  // ── REGIMM (op=1) ───────────────────────────────────────────────────────────
  if (op === 1) {
    const bname = {0x00:'bltz',0x01:'bgez',0x02:'bltzl',0x03:'bgezl',
                   0x10:'bltzal',0x11:'bgezal',0x12:'bltzall',0x13:'bgezall'};
    if (bname[rt] !== undefined)
      return `${mn(bname[rt])} ${r(rs)}, ${branchTarget(imm16,pc)}`;
    return null;
  }

  // ── COP0 ────────────────────────────────────────────────────────────────────
  if (op === 0x10) {
    if (rs === 0) return `${mn('mfc0')} ${r(rt)}, <span class="reg">c${rd}</span>`;
    if (rs === 4) return `${mn('mtc0')} ${r(rt)}, <span class="reg">c${rd}</span>`;
    if (rs === 0x10 && funct === 0x18) return `${mn('eret')}`;
    return null;
  }

  // ── COP1 (FPU) ──────────────────────────────────────────────────────────────
  if (op === 0x11) {
    if (rs === 0x00) return `${mn('mfc1')} ${r(rt)}, ${fr(rd)}`;
    if (rs === 0x04) return `${mn('mtc1')} ${r(rt)}, ${fr(rd)}`;
    if (rs === 0x08) {
      const bc = {0:'bc1f',1:'bc1t',2:'bc1fl',3:'bc1tl'};
      return bc[rt] ? `${mn(bc[rt])} ${branchTarget(imm16,pc)}` : null;
    }
    // FPU arithmetic (fmt = rs)
    const fmt_names = {0x10:'s',0x11:'d',0x14:'w',0x15:'l'};
    const fmt = fmt_names[rs];
    if (fmt) {
      const fp_ops = {
        0x00:'add',0x01:'sub',0x02:'mul',0x03:'div',
        0x04:'sqrt',0x05:'abs',0x06:'mov',0x07:'neg',
        0x08:'round.l',0x09:'trunc.l',0x0A:'ceil.l',0x0B:'floor.l',
        0x0C:'round.w',0x0D:'trunc.w',0x0E:'ceil.w',0x0F:'floor.w',
        0x20:'cvt.s',0x21:'cvt.d',0x24:'cvt.w',0x25:'cvt.l',
        0x30:'c.f',0x31:'c.un',0x32:'c.eq',0x33:'c.ueq',
        0x34:'c.olt',0x35:'c.ult',0x36:'c.ole',0x37:'c.ule',
        0x38:'c.sf',0x39:'c.ngle',0x3A:'c.seq',0x3B:'c.ngl',
        0x3C:'c.lt',0x3D:'c.nge',0x3E:'c.le',0x3F:'c.ngt'
      };
      const fname = fp_ops[funct];
      if (fname) {
        const fd = (word>>6)&0x1F;
        const fs = (word>>11)&0x1F;
        const ft_ = (word>>16)&0x1F;
        if (funct >= 0x04 && funct <= 0x07)
          return `${mn(fname+'.'+fmt)} ${fr(fd)}, ${fr(fs)}`;
        if (funct >= 0x30)
          return `${mn(fname+'.'+fmt)} ${fr(fs)}, ${fr(ft_)}`;
        if (funct >= 0x20)
          return `${mn(fname+'.'+fmt)} ${fr(fd)}, ${fr(fs)}`;
        return `${mn(fname+'.'+fmt)} ${fr(fd)}, ${fr(fs)}, ${fr(ft_)}`;
      }
    }
    return null;
  }

  // ── Standard I/J-type ───────────────────────────────────────────────────────
  switch(op) {
    case 0x02: return `${mn('j')} ${addr26(word,pc)}`;
    case 0x03: return `${mn('jal')} ${addr26(word,pc)}`;
    case 0x04:
      if (rs === rt) return `${ps('b')} ${branchTarget(imm16,pc)}`;
      return `${mn('beq')} ${r(rs)}, ${r(rt)}, ${branchTarget(imm16,pc)}`;
    case 0x05:
      if (rs === 0 && rt === 0) return `${ps('b')} ${branchTarget(imm16,pc)}`;
      return `${mn('bne')} ${r(rs)}, ${r(rt)}, ${branchTarget(imm16,pc)}`;
    case 0x06: return `${mn('blez')} ${r(rs)}, ${branchTarget(imm16,pc)}`;
    case 0x07: return `${mn('bgtz')} ${r(rs)}, ${branchTarget(imm16,pc)}`;
    case 0x08:
      if (rs === 0) return `${ps('li')} ${r(rt)}, ${immDec(imm16)}`;
      return `${mn('addi')} ${r(rt)}, ${r(rs)}, ${immDec(imm16)}`;
    case 0x09:
      if (rs === 0) return `${ps('li')} ${r(rt)}, ${immDec(imm16)}`;
      return `${mn('addiu')} ${r(rt)}, ${r(rs)}, ${immDec(imm16)}`;
    case 0x0A: return `${mn('slti')} ${r(rt)}, ${r(rs)}, ${immDec(imm16)}`;
    case 0x0B: return `${mn('sltiu')} ${r(rt)}, ${r(rs)}, ${immDec(imm16,false)}`;
    case 0x0C: return `${mn('andi')} ${r(rt)}, ${r(rs)}, ${imm(imm16,false)}`;
    case 0x0D: return `${mn('ori')} ${r(rt)}, ${r(rs)}, ${imm(imm16,false)}`;
    case 0x0E: return `${mn('xori')} ${r(rt)}, ${r(rs)}, ${imm(imm16,false)}`;
    case 0x0F: return `${mn('lui')} ${r(rt)}, ${imm(imm16,false)}`;
    case 0x14: return `${mn('beql')} ${r(rs)}, ${r(rt)}, ${branchTarget(imm16,pc)}`;
    case 0x15: return `${mn('bnel')} ${r(rs)}, ${r(rt)}, ${branchTarget(imm16,pc)}`;
    case 0x16: return `${mn('blezl')} ${r(rs)}, ${branchTarget(imm16,pc)}`;
    case 0x17: return `${mn('bgtzl')} ${r(rs)}, ${branchTarget(imm16,pc)}`;
    case 0x18: return `${mn('daddi')} ${r(rt)}, ${r(rs)}, ${immDec(imm16)}`;
    case 0x19: return `${mn('daddiu')} ${r(rt)}, ${r(rs)}, ${immDec(imm16)}`;
    case 0x1A: return `${mn('ldl')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x1B: return `${mn('ldr')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x20: return `${mn('lb')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x21: return `${mn('lh')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x22: return `${mn('lwl')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x23: return `${mn('lw')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x24: return `${mn('lbu')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x25: return `${mn('lhu')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x26: return `${mn('lwr')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x27: return `${mn('lwu')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x28: return `${mn('sb')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x29: return `${mn('sh')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x2A: return `${mn('swl')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x2B: return `${mn('sw')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x2C: return `${mn('sdl')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x2D: return `${mn('sdr')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x2E: return `${mn('swr')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x2F: return `${mn('cache')} ${immDec(rt,false)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x30: return `${mn('ll')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x31: return `${mn('lwc1')} ${fr(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x35: return `${mn('ldc1')} ${fr(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x37: return `${mn('ld')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x38: return `${mn('sc')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x39: return `${mn('swc1')} ${fr(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x3D: return `${mn('sdc1')} ${fr(rt)}, ${immDec(imm16)}(${r(rs)})`;
    case 0x3F: return `${mn('sd')} ${r(rt)}, ${immDec(imm16)}(${r(rs)})`;
  }
  return null;
}

// ─── Parse hex input ─────────────────────────────────────────────────────────
function parseHex(input) {
  // Remove 0x prefixes, whitespace, newlines, colons
  let clean = input.replace(/0x/gi,'').replace(/[^0-9a-fA-F]/g,'');
  // Must be divisible by 8 (4 bytes per word)
  let words = [];
  for (let i = 0; i+8 <= clean.length; i+=8) {
    words.push(parseInt(clean.slice(i,i+8), 16));
  }
  return words;
}

function disassemble() {
  const input = document.getElementById('hexInput').value;
  const baseStr = document.getElementById('baseAddr').value.replace(/0x/i,'');
  const baseAddr = parseInt(baseStr, 16) || 0x80246000;

  const words = parseHex(input);
  const out = document.getElementById('output');

  if (words.length === 0) {
    out.innerHTML = `<div class="error-row">// No valid hex data found.</div>`;
    document.getElementById('stats').style.display = 'none';
    return;
  }

  let html = '';
  let errCount = 0;
  let branchCount = 0;

  words.forEach((word, i) => {
    const pc = (baseAddr + i*4)>>>0;
    const addrStr = pc.toString(16).toUpperCase().padStart(8,'0');
    const hexStr = word.toString(16).toUpperCase().padStart(8,'0');

    let asm = disasmWord(word, pc);

    // Count branches
    const op = (word>>>26)&0x3F;
    if ([2,3,4,5,6,7,0x14,0x15,0x16,0x17].includes(op) ||
        (op===0 && [8,9].includes(word&0x3F)) ||
        op===1) branchCount++;

    if (asm === null) {
      asm = `<span class="comment">/* unknown: ${hexStr} */</span>`;
      errCount++;
    }

    html += `<div class="instr-row">
      <span class="addr">${addrStr}:</span>
      <span class="hex-col">${hexStr}</span>
      <span class="asm-col">${asm}</span>
    </div>`;
  });

  out.innerHTML = html;
  document.getElementById('statCount').textContent = words.length;
  document.getElementById('statErr').textContent = errCount;
  document.getElementById('statBranch').textContent = branchCount;
  document.getElementById('stats').style.display = 'flex';
}

function clearAll() {
  document.getElementById('hexInput').value = '';
  document.getElementById('output').innerHTML = `<div style="padding:40px 20px; color:#2a3a50; font-size:13px; line-height:2">// Cleared.</div>`;
  document.getElementById('stats').style.display = 'none';
}

const EXAMPLES = {
  prologue: `27BDFFE0 AFBF001C AFBE0018 AFB70014 AFB60010 AFB50014 AFB40010 AFB3000C AFB20008 AFB10004 AFB00000 03A0F025`,
  branch:   `8C820000 10400008 00000000 24420001 2C430010 1460FFFA 00000000 03E00008 00000000`,
  mario:    `3C018016 8C22A5D0 14400005 00000000 3C018016 8C22A5C8 3C038016 8C63A5D0 00431821 AC62A5D0 03E00008 00000000`
};

function loadExample(key) {
  document.getElementById('hexInput').value = EXAMPLES[key];
  disassemble();
}

// Auto-disassemble on paste
document.getElementById('hexInput').addEventListener('paste', ()=>{
  setTimeout(disassemble, 50);
});
</script>
</body>
</html>
