<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jack's Toolbox — MIPS R4300i</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=VT323&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

:root {
  --bg:       #1a1118;
  --bg2:      #201520;
  --panel:    #251a22;
  --panel2:   #2d2030;
  --border:   #4a2e3f;
  --border2:  #6b3d52;
  --rose:     #c4637a;
  --rose2:    #e8849a;
  --blush:    #f2b5c2;
  --petal:    #f7d5dc;
  --gold:     #c9935a;
  --gold2:    #e8b97a;
  --sage:     #7a9e7e;
  --sage2:    #9dbfa1;
  --lavender: #a07ab8;
  --muted:    #7a5468;
  --muted2:   #9e6e84;
  --text:     #e8cfd8;
  --text2:    #f5e8ed;
  --dim:      #4a2e3f;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg); color: var(--text);
  font-family: 'VT323', monospace;
  height: 100vh; display: flex; flex-direction: column; overflow: hidden;
}

body::before {
  content: ''; position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none; z-index: 9998; opacity: 0.6;
}
body::after {
  content: ''; position: fixed; inset: 0;
  background: repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.04) 3px,rgba(0,0,0,0.04) 4px);
  pointer-events: none; z-index: 9999;
}

header {
  padding: 10px 22px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 14px;
  background: linear-gradient(180deg,#120d12 0%,var(--bg) 100%);
  flex-shrink: 0; position: relative;
}
header::after {
  content: ''; position: absolute; bottom:0; left:0; right:0; height:1px;
  background: linear-gradient(90deg,transparent,var(--rose) 30%,var(--border2) 70%,transparent);
  opacity: 0.4;
}
.hdr-divider { width:1px; height:36px; background:linear-gradient(180deg,transparent,var(--border2),transparent); flex-shrink:0; }
.logo-title { font-family:'IM Fell English',serif; font-size:22px; color:var(--blush); letter-spacing:1px; text-shadow:0 0 20px rgba(196,99,122,0.6),0 1px 0 rgba(0,0,0,0.5); line-height:1; }
.logo-title em { font-style:italic; color:var(--gold2); text-shadow:0 0 14px rgba(201,147,90,0.5); }
.logo-sub { font-size:13px; color:var(--muted2); letter-spacing:2px; margin-top:1px; }
.rom-status { margin-left:auto; font-size:14px; color:var(--muted); letter-spacing:1px; }
.rom-status.loaded { color:var(--sage2); text-shadow:0 0 8px rgba(122,158,126,0.5); }

.tabbar { display:flex; border-bottom:1px solid var(--border); flex-shrink:0; background:var(--bg2); }
.tab { padding:8px 15px; font-size:14px; letter-spacing:1px; color:var(--muted); cursor:pointer; border-right:1px solid var(--border); border-bottom:2px solid transparent; transition:all .2s; user-select:none; }
.tab:hover { color:var(--blush); background:rgba(196,99,122,0.05); }
.tab.active { color:var(--blush); border-bottom-color:var(--rose); background:rgba(196,99,122,0.08); text-shadow:0 0 10px rgba(196,99,122,0.4); }

.workspace { flex:1; display:flex; overflow:hidden; }
.pane { display:flex; flex-direction:column; flex:1; overflow:hidden; border-right:1px solid var(--border); }
.pane:last-child { border-right:none; }
.pane-hdr { padding:7px 14px; background:var(--panel); border-bottom:1px solid var(--border); font-size:13px; letter-spacing:2px; color:var(--muted2); display:flex; align-items:center; gap:8px; flex-shrink:0; }
.dot { width:7px; height:7px; border-radius:50%; background:var(--rose); box-shadow:0 0 6px var(--rose); flex-shrink:0; }
.dot.g { background:var(--sage); box-shadow:0 0 6px var(--sage); }
.dot.b { background:var(--lavender); box-shadow:0 0 6px var(--lavender); }
.dot.y { background:var(--gold); box-shadow:0 0 6px var(--gold); }

.ctrls { padding:6px 14px; border-bottom:1px solid var(--border); display:flex; gap:5px; align-items:center; flex-wrap:wrap; background:var(--panel2); flex-shrink:0; }
label { font-size:13px; color:var(--muted2); letter-spacing:1px; }
input[type="text"] { background:var(--bg); border:1px solid var(--border); color:var(--blush); font-family:'VT323',monospace; font-size:14px; padding:3px 7px; outline:none; transition:border-color .2s,box-shadow .2s; }
input[type="text"]:focus { border-color:var(--rose); box-shadow:0 0 8px rgba(196,99,122,0.25); }
input[type="text"]::placeholder { color:var(--dim); }
.btn { background:linear-gradient(180deg,#3d1e2c 0%,#2a1320 100%); color:var(--blush); border:1px solid var(--border2); font-family:'VT323',monospace; font-size:14px; letter-spacing:1px; padding:4px 11px; cursor:pointer; transition:all .15s; text-shadow:0 0 8px rgba(242,181,194,0.3); box-shadow:inset 0 1px 0 rgba(255,255,255,0.06),0 1px 3px rgba(0,0,0,0.4); }
.btn:hover { background:linear-gradient(180deg,#5a2a3d 0%,#3d1e2c 100%); border-color:var(--rose); color:var(--petal); box-shadow:0 0 10px rgba(196,99,122,0.3); }
.btn:active { box-shadow:inset 0 2px 4px rgba(0,0,0,0.4); }
.btn.sec { background:transparent; border:1px solid var(--border); color:var(--muted2); box-shadow:none; text-shadow:none; }
.btn.sec:hover { border-color:var(--border2); color:var(--text); }
.btn.grn { background:linear-gradient(180deg,#1e3020 0%,#141e15 100%); border:1px solid var(--sage); color:var(--sage2); text-shadow:0 0 8px rgba(122,158,126,0.4); }
.btn.grn:hover { background:linear-gradient(180deg,#2a4030 0%,#1e3020 100%); box-shadow:0 0 10px rgba(122,158,126,0.25); }
.btn.blu { background:linear-gradient(180deg,#281e38 0%,#1a1325 100%); border:1px solid var(--lavender); color:#c4a8d8; text-shadow:0 0 8px rgba(160,122,184,0.4); }
.btn.blu:hover { background:linear-gradient(180deg,#382a4c 0%,#281e38 100%); box-shadow:0 0 10px rgba(160,122,184,0.25); }

.tab-content { display:none; flex:1; overflow:hidden; flex-direction:column; }
.tab-content.active { display:flex; }

/* ── DISASM ROWS ── */
.out-area { flex:1; overflow-y:auto; padding:4px 0; scrollbar-width:thin; scrollbar-color:var(--border2) transparent; }
.out-area::-webkit-scrollbar { width:6px; }
.out-area::-webkit-scrollbar-thumb { background:var(--border2); border-radius:3px; }

.irow { display:grid; grid-template-columns:106px 88px 1fr; padding:1px 14px; font-family:'VT323',monospace; font-size:15px; line-height:1.75; transition:background .1s; }
.irow:hover { background:rgba(196,99,122,0.05); }
.irow.hi { background:rgba(201,147,90,0.12); box-shadow:inset 2px 0 0 var(--gold); }
.fn-label-row { padding:6px 14px 2px; font-family:'IM Fell English',serif; font-style:italic; font-size:12px; color:var(--gold); border-top:1px solid rgba(201,147,90,0.15); margin-top:6px; }
.addr-c { color:var(--muted); user-select:none; }
.addr-c.click { cursor:pointer; }
.addr-c.click:hover { color:var(--gold2); }
.hcol { color:var(--dim); opacity:0.6; user-select:none; }
.acol { user-select:text; }
.mn { color:var(--blush); }
.rg { color:var(--gold2); }
.im { color:var(--sage2); }
.lref { color:var(--rose2); cursor:pointer; text-decoration:underline dotted rgba(232,132,154,0.4); }
.lref:hover { color:var(--petal); }
.cmt { color:var(--dim); opacity:0.8; font-style:italic; }
.psd { color:var(--lavender); font-style:italic; }
.err { color:var(--rose); opacity:.65; }
.stats { padding:5px 14px; border-top:1px solid var(--border); font-size:13px; color:var(--muted); display:flex; gap:14px; flex-shrink:0; background:var(--panel); }
.stats span { color:var(--text2); }
textarea { flex:1; background:transparent; border:none; color:var(--text); font-family:'VT323',monospace; font-size:14px; padding:10px 14px; resize:none; outline:none; line-height:1.7; }
textarea::placeholder { color:var(--dim); }

/* ── ASM EDITOR — gutter + textarea side by side ── */
.asm-wrap { flex:1; display:flex; overflow:hidden; }
.asm-gutter {
  width:112px; flex-shrink:0; overflow:hidden;
  padding:10px 0 0; border-right:1px solid var(--border);
  background:var(--panel); pointer-events:none; user-select:none;
}
.asm-gl {
  height:26.25px; /* 15px * 1.75 */
  padding:0 8px 0 10px;
  color:var(--muted); font-family:'VT323',monospace; font-size:15px;
  line-height:26.25px; white-space:nowrap; overflow:hidden;
  border-bottom:1px solid transparent;
}
.asm-gl.fnmark { color:var(--gold2); }
.asm-gl.empty  { color:var(--dim); opacity:0.25; }
#asmIn {
  flex:1; background:transparent; border:none; color:var(--text);
  font-family:'VT323',monospace; font-size:15px;
  padding:10px 14px; resize:none; outline:none; line-height:1.75;
  overflow-y:scroll; scrollbar-width:thin; scrollbar-color:var(--border2) transparent;
}
#asmIn::-webkit-scrollbar { width:6px; }
#asmIn::-webkit-scrollbar-thumb { background:var(--border2); }
#asmIn::placeholder { color:var(--dim); }

/* assembled output strip (below editor) */
#asmOutPanel { max-height:200px; overflow-y:auto; border-top:1px solid var(--border); background:var(--bg); scrollbar-width:thin; scrollbar-color:var(--border2) transparent; display:none; }
#asmOutPanel::-webkit-scrollbar { width:5px; }
#asmOutPanel::-webkit-scrollbar-thumb { background:var(--border2); }

/* ── ROM LOADER ── */
.drop-zone { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; color:var(--muted); border:1px dashed var(--border2); margin:16px; transition:all .25s; cursor:pointer; position:relative; overflow:hidden; }
.drop-zone::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at center,rgba(196,99,122,0.04) 0%,transparent 70%); pointer-events:none; }
.drop-zone:hover,.drop-zone.drag { border-color:var(--rose); color:var(--blush); background:rgba(196,99,122,0.04); }
.drop-icon { font-size:42px; opacity:.4; }
.drop-text { font-family:'IM Fell English',serif; font-style:italic; font-size:16px; letter-spacing:1px; color:var(--blush); }
.drop-sub { font-size:13px; opacity:.5; letter-spacing:1px; }
.rom-info { padding:10px 16px; border-bottom:1px solid var(--border); display:grid; grid-template-columns:1fr 1fr; gap:6px; flex-shrink:0; background:var(--panel2); }
.rf .k { color:var(--muted2); margin-right:6px; font-size:13px; }
.rf .v { color:var(--blush); font-size:13px; }

/* ── HEX EDITOR ── */
.hex-toolbar { padding:6px 12px; border-bottom:1px solid var(--border); display:flex; gap:4px; align-items:center; flex-wrap:wrap; background:var(--panel2); flex-shrink:0; }
.hex-main { flex:1; overflow:hidden; display:flex; flex-direction:column; }
.hex-col-hdr {
  display:flex; align-items:center; padding:4px 12px; gap:0;
  border-bottom:1px solid var(--border); position:sticky; top:0;
  background:var(--panel); z-index:10; font-size:12px; color:var(--muted); user-select:none;
}
.hch-off { width:86px; flex-shrink:0; color:var(--muted2); letter-spacing:1px; }
.hch-gap { width:10px; flex-shrink:0; }
.hch-gap2 { width:14px; flex-shrink:0; }
.hch-b { width:26px; text-align:center; flex-shrink:0; }
.hch-b.mid { color:var(--rose2); }
.hch-asc { color:var(--muted2); letter-spacing:1px; font-size:11px; }

.hex-scroll { flex:1; overflow-y:auto; overflow-x:hidden; scrollbar-width:thin; scrollbar-color:var(--border2) transparent; background:var(--bg); font-family:'VT323',monospace; font-size:14px; line-height:1.6; }
.hex-scroll::-webkit-scrollbar { width:6px; }
.hex-scroll::-webkit-scrollbar-thumb { background:var(--border2); border-radius:3px; }

.hx-row { display:flex; align-items:center; padding:0 12px; min-height:22px; }
.hx-row:hover { background:rgba(196,99,122,0.03); }
.hx-off { width:86px; flex-shrink:0; color:var(--muted); font-size:13px; user-select:none; letter-spacing:1px; }
.hx-gap { width:10px; flex-shrink:0; }
.hx-gap2 { width:14px; flex-shrink:0; }
.hx-cell {
  width:26px; height:20px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:14px; cursor:pointer; border:1px solid transparent;
  transition:all .06s; user-select:none; color:var(--muted2);
}
.hx-cell:hover { background:rgba(160,122,184,0.15); border-color:var(--lavender); color:#d4b8e8; }
.hx-cell.sel { background:rgba(196,99,122,0.22); border-color:var(--rose); color:var(--petal); }
.hx-cell.sel-anc { background:rgba(201,147,90,0.28); border-color:var(--gold); color:var(--gold2); }
.hx-cell.nb { color:var(--dim); opacity:0.3; }
.hx-cell.hb { color:var(--rose2); }
.hx-cell.pb { color:var(--text); }
.hx-cell.sm { background:rgba(122,158,126,0.2); border-color:var(--sage); }
.hx-cell.sc { background:rgba(122,158,126,0.5); border-color:var(--sage2); color:#e8ffc0; }
.hx-asc { display:flex; }
.hx-ac {
  width:9px; flex-shrink:0; text-align:center;
  cursor:pointer; font-size:14px; color:var(--dim);
  user-select:none;
}
.hx-ac:hover { color:var(--muted2); }
.hx-ac.ap { color:var(--sage2); }
.hx-ac.an { opacity:0.2; }
.hx-ac.as { color:var(--petal); background:rgba(196,99,122,0.15); }

.hex-status { padding:5px 12px; border-top:1px solid var(--border); background:var(--panel); font-size:13px; color:var(--muted); display:flex; gap:12px; flex-shrink:0; align-items:center; flex-wrap:wrap; }
.hstat { color:var(--text2); }

/* ── FUNCTIONS — single pane ── */
#tab-funcs { display:none; flex-direction:column; }
#tab-funcs.active { display:flex; }
.fn-list { flex:1; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border2) transparent; }
.fn-list::-webkit-scrollbar { width:5px; }
.fn-list::-webkit-scrollbar-thumb { background:var(--border2); }
.fn-row { display:flex; align-items:center; padding:5px 14px; gap:10px; border-bottom:1px solid rgba(74,46,63,0.45); cursor:pointer; transition:background .1s; }
.fn-row:hover { background:rgba(196,99,122,0.06); }
.fn-addr-s { color:var(--gold); font-size:13px; width:84px; flex-shrink:0; font-family:'VT323',monospace; letter-spacing:1px; }
.fn-name-s { flex:1; color:var(--text); font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.fn-cat-s { font-size:10px; letter-spacing:1px; padding:1px 5px; border:1px solid currentColor; flex-shrink:0; opacity:0.8; }
.fn-del { font-size:13px; color:var(--dim); cursor:pointer; flex-shrink:0; padding:0 3px; }
.fn-del:hover { color:var(--rose); }
.fn-add-bar { padding:6px 14px; border-top:1px solid var(--border); display:flex; gap:5px; flex-shrink:0; background:var(--panel2); align-items:center; }

/* ── TOOLTIP ── */
.fn-tt { position:fixed; background:var(--panel2); border:1px solid var(--border2); border-left:2px solid var(--rose); color:var(--blush); font-family:'VT323',monospace; font-size:13px; padding:5px 10px; pointer-events:none; z-index:99999; max-width:340px; white-space:normal; line-height:1.4; box-shadow:0 4px 16px rgba(0,0,0,0.5); }
.fn-tt .tt-nm { color:var(--gold2); font-size:14px; }
.fn-tt .tt-ar { color:var(--sage2); font-size:12px; margin-top:2px; }

/* ── COMING SOON ── */
.coming-soon { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; }
.cs-title { font-family:'IM Fell English',serif; font-style:italic; font-size:28px; color:var(--blush); opacity:0.7; }
.cs-sub { font-size:14px; letter-spacing:3px; color:var(--muted); opacity:0.6; }
.cs-deco { font-size:11px; color:var(--dim); letter-spacing:2px; margin-top:8px; }

.ex-strip { padding:5px 14px; border-bottom:1px solid var(--border); display:flex; gap:5px; flex-wrap:wrap; background:var(--panel); flex-shrink:0; align-items:center; }
.ex-strip label { font-size:12px; opacity:.7; }

#toast { position:fixed; bottom:16px; right:16px; background:var(--panel2); border:1px solid var(--border2); border-left:3px solid var(--rose); color:var(--blush); padding:8px 14px; font-family:'VT323',monospace; font-size:14px; letter-spacing:1px; opacity:0; transition:opacity .3s; pointer-events:none; z-index:10000; box-shadow:0 4px 16px rgba(0,0,0,0.4); }
#toast.show { opacity:1; }

::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:3px; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <img src="logo.png" style="width:40px;height:40px" onerror="this.style.display='none'">
  <div class="hdr-divider"></div>
  <div>
    <div class="logo-title">Jack's <em>Toolbox</em></div>
    <div class="logo-sub">MIPS R4300i &middot; BETA V0.6</div>
  </div>
  <div class="hdr-divider"></div>
  <div class="rom-status" id="romStatus">No ROM Loaded</div>
</header>

<!-- TABS -->
<div class="tabbar">
  <div class="tab active"  onclick="switchTab('disasm')">Hex → ASM</div>
  <div class="tab"         onclick="switchTab('rom')">ROM Loader</div>
  <div class="tab"         onclick="switchTab('asmEdit')">ASM Editor</div>
  <div class="tab"         onclick="switchTab('hexEdit')">Hex Editor</div>
  <div class="tab"         onclick="switchTab('funcs')">Functions</div>
  <div class="tab"         onclick="switchTab('lvlscript')">Level Script (Soon)</div>
  <div class="tab"         onclick="switchTab('geolayout')">Geo Layout (Soon)</div>
</div>

<!-- ══════════════════════════════════════════════
     TAB 1  —  HEX → ASM
     Paste raw hex, get read-only disassembly.
     "→ ASM Editor" pushes plain text to edit tab.
     ══════════════════════════════════════════════ -->
<div class="tab-content active" id="tab-disasm">
  <div class="workspace">
    <!-- hex input -->
    <div class="pane" style="max-width:42%">
      <div class="pane-hdr"><div class="dot"></div> raw hex input</div>
      <div class="ctrls">
        <label>base addr</label>
        <input type="text" id="baseAddr" value="80246000" maxlength="10" style="width:106px">
        <button class="btn" onclick="disassemble()">decode</button>
        <button class="btn sec" onclick="clearDisasm()">clear</button>
      </div>
      <div class="ex-strip">
        <label>examples ›</label>
        <button class="btn sec" style="padding:2px 8px;font-size:12px" onclick="loadEx('prologue')">prologue</button>
        <button class="btn sec" style="padding:2px 8px;font-size:12px" onclick="loadEx('branch')">branch loop</button>
        <button class="btn sec" style="padding:2px 8px;font-size:12px" onclick="loadEx('mario')">mario physics</button>
      </div>
      <textarea id="hexInput" placeholder="paste raw hex bytes here...&#10;&#10;  27BDFFE0 AFBF001C&#10;  or: 27BDFFE0AFBF001C&#10;&#10;4 bytes per instruction (big-endian)"></textarea>
    </div>
    <!-- decoded output — READ ONLY -->
    <div class="pane">
      <div class="pane-hdr">
        <div class="dot g"></div> decoded mips assembly
        <span style="margin-left:auto;font-size:11px;color:var(--dim)">read-only · click branch targets to jump</span>
      </div>
      <div class="ctrls">
        <label>jump to</label>
        <input type="text" id="d_jumpIn" placeholder="80246000" style="width:106px">
        <button class="btn sec" onclick="disasmJump()">go</button>
        <button class="btn grn" style="margin-left:auto" onclick="pushToAsmEditor()" title="Send plain-text assembly to ASM Editor">→ ASM Editor</button>
      </div>
      <div class="out-area" id="disasmOut">
        <div style="padding:30px 14px;color:var(--dim);font-size:14px;line-height:2;font-style:italic;font-family:'IM Fell English',serif">
          // paste hex on the left and click decode<br>
          // SM64 · MIPS R4300i · big-endian 32-bit
        </div>
      </div>
      <div class="stats" id="dStats" style="display:none">
        instructions: <span id="sCnt">0</span> &nbsp;·&nbsp;
        errors: <span id="sErr">0</span> &nbsp;·&nbsp;
        branches: <span id="sBr">0</span>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════
     TAB 2  —  ROM LOADER
     Drop/browse ROM. On load: auto-populates
     BOTH the hex editor (raw bytes) AND the ASM
     editor (decoded assembly) from the chosen section.
     ══════════════════════════════════════════════ -->
<div class="tab-content" id="tab-rom">
  <div class="pane-hdr"><div class="dot y"></div> rom file loader</div>
  <div id="romInfoBar" class="rom-info" style="display:none">
    <div class="rf"><span class="k">file</span><span class="v" id="ri-name"></span></div>
    <div class="rf"><span class="k">size</span><span class="v" id="ri-size"></span></div>
    <div class="rf"><span class="k">format</span><span class="v" id="ri-fmt"></span></div>
    <div class="rf"><span class="k">crc1</span><span class="v" id="ri-crc1"></span></div>
    <div class="rf"><span class="k">crc2</span><span class="v" id="ri-crc2"></span></div>
    <div class="rf"><span class="k">title</span><span class="v" id="ri-title"></span></div>
  </div>
  <div class="ctrls" id="romGoBar" style="display:none">
    <label>offset (hex)</label>
    <input type="text" id="romOffset" value="1000" style="width:78px">
    <label>length (hex bytes)</label>
    <input type="text" id="romLen" value="200" style="width:70px">
    <label>virtual addr</label>
    <input type="text" id="romVaddr" value="80246000" style="width:106px">
    <button class="btn" onclick="romLoadSection()">load section → both editors</button>
    <button class="btn blu" onclick="romLoadFullHex()">full ROM → hex editor only</button>
  </div>
  <div id="dropZone" class="drop-zone"
       onclick="document.getElementById('romFile').click()"
       ondragover="event.preventDefault();this.classList.add('drag')"
       ondragleave="this.classList.remove('drag')"
       ondrop="handleRomDrop(event)">
    <div class="drop-icon">[ROM]</div>
    <div class="drop-text">drop your ROM file here</div>
    <div class="drop-sub">.z64 · .n64 · .v64 — or click to browse</div>
    <input type="file" id="romFile" accept=".z64,.n64,.v64,.bin" style="display:none" onchange="loadRomFile(this.files[0])">
  </div>
</div>

<!-- ══════════════════════════════════════════════
     TAB 3  —  ASM EDITOR
     Left gutter: auto-computed non-editable virtual
     addresses, updated on every keystroke.
     Right: editable assembly textarea.
     Jump-to-addr scrolls to the matching line.
     Assemble button → hex output strip below.
     ══════════════════════════════════════════════ -->
<div class="tab-content" id="tab-asmEdit">
  <div class="pane-hdr">
    <div class="dot b"></div> asm editor
    <span style="margin-left:8px;font-size:11px;color:var(--dim)">address gutter is auto-computed &amp; non-editable</span>
    <span id="asmStat" style="margin-left:auto;font-size:13px;color:var(--muted2)"></span>
  </div>
  <div class="ctrls">
    <label>base addr</label>
    <input type="text" id="asmBase" value="80246000" style="width:106px" oninput="updateGutter()">
    <button class="btn" onclick="asmAssemble()">assemble → hex</button>
    <button class="btn sec" onclick="asmCopyHex()">copy hex</button>
    <button class="btn blu" onclick="asmPushToHex()">→ hex editor</button>
    <span style="color:var(--border2);margin:0 2px">·</span>
    <label>jump to addr</label>
    <input type="text" id="a_jumpIn" placeholder="80246000" style="width:106px">
    <button class="btn sec" onclick="asmJump()">go</button>
  </div>
  <!-- gutter + textarea -->
  <div class="asm-wrap">
    <div class="asm-gutter" id="asmGutter"></div>
    <textarea id="asmIn" spellcheck="false"
      placeholder="; MIPS assembly — auto-loaded on ROM load&#10;; one instruction per line&#10;; comments start with ; or //&#10;&#10;addiu sp, sp, -0x20&#10;sw    ra, 0x1C(sp)&#10;jal   0x80246ABC&#10;nop"
      oninput="updateGutter()"></textarea>
  </div>
  <!-- assembled output (shown after clicking "assemble") -->
  <div id="asmOutPanel">
    <div class="out-area" id="asmOut" style="flex:none;padding:4px 0;max-height:200px"></div>
  </div>
</div>

<!-- ══════════════════════════════════════════════
     TAB 4  —  HEX EDITOR
     ══════════════════════════════════════════════ -->
<div class="tab-content" id="tab-hexEdit">
  <div class="hex-toolbar">
    <label>jump to offset</label>
    <input type="text" id="h_jumpIn" placeholder="0x1000" style="width:86px">
    <button class="btn" onclick="hexJump()">go</button>
    <span style="color:var(--border2)">·</span>
    <label>find bytes</label>
    <input type="text" id="h_searchIn" placeholder="FF 00 FF" style="width:116px">
    <button class="btn sec" onclick="hexSearchNext()">next</button>
    <button class="btn sec" onclick="hexSearchPrev()">prev</button>
    <span id="h_searchInfo" style="font-size:12px;color:var(--muted2)"></span>
    <span style="color:var(--border2)">·</span>
    <button class="btn sec" onclick="hexSelAll()">sel all</button>
    <button class="btn grn" onclick="hexCopySel()">copy sel</button>
    <button class="btn" onclick="hexPasteOver()">paste</button>
    <button class="btn sec" onclick="hexPasteIns()">insert</button>
    <button class="btn sec" onclick="hexClear()">clear</button>
    <button class="btn blu" onclick="hexDisasm()">disasm sel</button>
  </div>
  <div class="hex-main">
    <div class="hex-col-hdr">
      <span class="hch-off">OFFSET</span>
      <span class="hch-gap"></span>
      <span class="hch-b">00</span><span class="hch-b">01</span><span class="hch-b">02</span><span class="hch-b">03</span>
      <span class="hch-b">04</span><span class="hch-b">05</span><span class="hch-b">06</span><span class="hch-b">07</span>
      <span class="hch-b mid">08</span><span class="hch-b">09</span><span class="hch-b">0A</span><span class="hch-b">0B</span>
      <span class="hch-b">0C</span><span class="hch-b">0D</span><span class="hch-b">0E</span><span class="hch-b">0F</span>
      <span class="hch-gap2"></span>
      <span class="hch-asc">DECODED TEXT</span>
    </div>
    <div class="hex-scroll" id="hexScroll">
      <div style="padding:28px 14px;color:var(--dim);font-size:14px;font-style:italic;font-family:'IM Fell English',serif">
        // no data — load a ROM or paste hex below
      </div>
    </div>
  </div>
  <div class="hex-status">
    <span style="color:var(--muted)">size</span><span class="hstat" id="hsSz">—</span>
    <span style="color:var(--muted)">offset</span><span class="hstat" id="hsOff">—</span>
    <span style="color:var(--muted)">value</span><span class="hstat" id="hsVal">—</span>
    <span style="color:var(--muted)">sel</span><span class="hstat" id="hsSel">—</span>
    <span style="margin-left:auto;display:flex;gap:5px;align-items:center">
      <label>load hex:</label>
      <input type="text" id="h_rawIn" placeholder="paste hex bytes..." style="width:160px">
      <button class="btn sec" onclick="loadHexRaw()">load</button>
      <label style="margin-left:4px">patch:</label>
      <input type="text" id="h_patch" placeholder="FF" style="width:36px;text-transform:uppercase" maxlength="2">
      <button class="btn" onclick="doPatch()">patch</button>
    </span>
  </div>
</div>

<!-- ══════════════════════════════════════════════
     TAB 5  —  FUNCTIONS
     Single pane. Full list from functionMapReduced.txt.
     Search, add, remove, auto-detect, export.
     Clicking a row jumps the ASM editor to that address.
     ══════════════════════════════════════════════ -->
<div class="tab-content" id="tab-funcs">
  <div class="pane-hdr">
    <div class="dot y"></div> functions
    <span id="fnCount" style="margin-left:6px;color:var(--dim);font-size:12px"></span>
    <span style="margin-left:auto;font-size:11px;color:var(--dim)">click row → jump in ASM editor</span>
  </div>
  <div class="ctrls">
    <label>search</label>
    <input type="text" id="fnSearch" oninput="renderFns()" placeholder="name or address..." style="width:200px">
    <button class="btn sec" onclick="autoDetectFns()">auto-detect JAL</button>
    <button class="btn sec" onclick="clearFns()">clear</button>
    <button class="btn grn" onclick="exportFns()">export</button>
  </div>
  <div class="fn-list" id="fnList">
    <div style="padding:28px 14px;color:var(--dim);font-size:13px;font-style:italic;font-family:'IM Fell English',serif">
      // loading function map...
    </div>
  </div>
  <div class="fn-add-bar">
    <label>add:</label>
    <input type="text" id="fnAddr" placeholder="80246ABC" style="width:106px" maxlength="10">
    <input type="text" id="fnName" placeholder="func_name" style="width:160px">
    <button class="btn" onclick="addFn()">add</button>
  </div>
</div>

<!-- COMING SOON -->
<div class="tab-content" id="tab-lvlscript">
  <div class="pane-hdr"><div class="dot y"></div> level script editor</div>
  <div class="coming-soon">
    <div class="cs-title">Level Script Editor</div>
    <div class="cs-sub">coming soon</div>
    <div class="cs-deco">parse and edit SM64 level scripts · cmd 0x00–0x3E · visual block editor</div>
  </div>
</div>
<div class="tab-content" id="tab-geolayout">
  <div class="pane-hdr"><div class="dot b"></div> geo layout editor</div>
  <div class="coming-soon">
    <div class="cs-title">Geo Layout Editor</div>
    <div class="cs-sub">coming soon</div>
    <div class="cs-deco">parse and visualize SM64 geo display lists · node tree view · layer &amp; shadow control</div>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';

// ─────────────────────────── STATE ───────────────────────────
let romData    = null;
let hexBytes   = [];
let hexSelSt   = -1, hexSelEn = -1, hexSelAnc = -1;
let hexSrRes   = [], hexSrIdx = 0, hexSrLen = 0;
let functions  = [];
let lastWords  = [], lastBase = 0;   // updated by hex→asm decode OR rom section load
const KNOWN    = {};                  // addr → {name,cat,args}
const HEX_COLS = 16;
const LINE_H   = 15 * 1.75;          // px per gutter line

// ─────────────────────────── FUNCTION MAP ────────────────────
async function loadFunctionMap() {
  try {
    const res = await fetch('functionMapReduced.txt');
    if (!res.ok) throw 0;
    const text = await res.text();
    const re = /"([0-9a-fA-F]{8})":\s*"([^"]+)"/g;
    let m, n = 0;
    while ((m = re.exec(text)) !== null) {
      const addr = parseInt(m[1], 16) >>> 0;
      KNOWN[addr] = { name: m[2], cat: '', args: '' };
      n++;
    }
    for (const [a, info] of Object.entries(KNOWN)) {
      const addr = parseInt(a) >>> 0;
      if (!functions.find(f => f.addr === addr))
        functions.push({ addr, name: info.name, desc: '', cat: '', builtin: true });
    }
    functions.sort((a, b) => a.addr - b.addr);
    renderFns();
    toast(`loaded ${n} functions`);
  } catch {
    document.getElementById('fnList').innerHTML =
      '<div style="padding:24px 14px;color:var(--rose);font-size:13px;font-style:italic;font-family:\'IM Fell English\',serif">// functionMapReduced.txt not found<br>// place it next to this html file</div>';
  }
}
loadFunctionMap();

const lookupFn = addr => {
  const a = addr >>> 0;
  return KNOWN[a] || (functions.find(f => f.addr === a)
    ? { name: functions.find(f => f.addr === a).name, args: '', cat: '' } : null);
};

// ─────────────────────────── TOOLTIP ─────────────────────────
let _tip = null;
function showTip(e, addr) {
  hideTip();
  const info = lookupFn(addr);
  if (!info) return;
  const el = document.createElement('div'); el.className = 'fn-tt';
  el.innerHTML = `<div class="tt-nm">${info.name}</div>${info.args ? `<div class="tt-ar">${info.args}</div>` : ''}`;
  document.body.appendChild(el); _tip = el; posTip(e);
}
function posTip(e) {
  if (!_tip) return;
  _tip.style.left = Math.min(e.clientX + 14, innerWidth  - _tip.offsetWidth  - 8) + 'px';
  _tip.style.top  = Math.min(e.clientY + 14, innerHeight - _tip.offsetHeight - 8) + 'px';
}
function hideTip() { if (_tip) { _tip.remove(); _tip = null; } }
document.addEventListener('mousemove', posTip);

// ─────────────────────────── TABS ────────────────────────────
const TID = ['disasm','rom','asmEdit','hexEdit','funcs','lvlscript','geolayout'];
function switchTab(id) {
  document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', TID[i] === id));
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
}

// ─────────────────────────── MIPS DECODER ────────────────────
const REGS = ['r0','at','v0','v1','a0','a1','a2','a3','t0','t1','t2','t3','t4','t5','t6','t7',
              's0','s1','s2','s3','s4','s5','s6','s7','t8','t9','k0','k1','gp','sp','fp','ra'];
const RMAP = {}; REGS.forEach((n, i) => RMAP[n] = i); RMAP['zero'] = 0;

const rn  = n => `<span class="rg">${REGS[n]}</span>`;
const frn = n => `<span class="rg">f${n}</span>`;
function hi(n, s = true) {
  let v = s ? (n << 16 >> 16) : n;
  return `<span class="im">${s && v < 0 ? '-0x' + (-v).toString(16).toUpperCase() : '0x' + (v >>> 0).toString(16).toUpperCase()}</span>`;
}
function brt(imm16, pc) {
  const t = (pc + 4 + ((imm16 << 16 >> 16) * 4)) >>> 0;
  const ts = t.toString(16).toUpperCase().padStart(8, '0');
  return `<span class="lref" onclick="gotoAddr(0x${ts})" onmouseenter="showTip(event,0x${ts})" onmouseleave="hideTip()">0x${ts}</span>`;
}
function j26(w, pc) {
  const t = ((pc & 0xF0000000) | ((w & 0x3FFFFFF) << 2)) >>> 0;
  const ts = t.toString(16).toUpperCase().padStart(8, '0');
  return `<span class="lref" onclick="gotoAddr(0x${ts})" onmouseenter="showTip(event,0x${ts})" onmouseleave="hideTip()">0x${ts}</span>`;
}

function dw(word, pc) {
  const op=(word>>>26)&0x3F, rs=(word>>>21)&0x1F, rt=(word>>>16)&0x1F,
        rd=(word>>>11)&0x1F, sa=(word>>>6)&0x1F, fn=word&0x3F, imm=word&0xFFFF;
  const m = s => `<span class="mn">${s}</span>`;
  const p = s => `<span class="psd">${s}</span>`;

  if (op === 0) {
    switch (fn) {
      case 0x00: return word===0 ? p('nop') : `${m('sll')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
      case 0x02: return `${m('srl')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
      case 0x03: return `${m('sra')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
      case 0x04: return `${m('sllv')} ${rn(rd)}, ${rn(rt)}, ${rn(rs)}`;
      case 0x06: return `${m('srlv')} ${rn(rd)}, ${rn(rt)}, ${rn(rs)}`;
      case 0x07: return `${m('srav')} ${rn(rd)}, ${rn(rt)}, ${rn(rs)}`;
      case 0x08: return `${m('jr')} ${rn(rs)}`;
      case 0x09: return rd===31 ? `${p('jalr')} ${rn(rs)}` : `${m('jalr')} ${rn(rd)}, ${rn(rs)}`;
      case 0x0C: return m('syscall'); case 0x0D: return m('break'); case 0x0F: return m('sync');
      case 0x10: return `${m('mfhi')} ${rn(rd)}`; case 0x11: return `${m('mthi')} ${rn(rs)}`;
      case 0x12: return `${m('mflo')} ${rn(rd)}`; case 0x13: return `${m('mtlo')} ${rn(rs)}`;
      case 0x18: return `${m('mult')} ${rn(rs)}, ${rn(rt)}`; case 0x19: return `${m('multu')} ${rn(rs)}, ${rn(rt)}`;
      case 0x1A: return `${m('div')} ${rn(rs)}, ${rn(rt)}`; case 0x1B: return `${m('divu')} ${rn(rs)}, ${rn(rt)}`;
      case 0x1C: return `${m('dmult')} ${rn(rs)}, ${rn(rt)}`; case 0x1D: return `${m('dmultu')} ${rn(rs)}, ${rn(rt)}`;
      case 0x1E: return `${m('ddiv')} ${rn(rs)}, ${rn(rt)}`; case 0x1F: return `${m('ddivu')} ${rn(rs)}, ${rn(rt)}`;
      case 0x20: return rs===0 ? `${p('move')} ${rn(rd)}, ${rn(rt)}` : `${m('add')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x21: return rs===0 ? `${p('move')} ${rn(rd)}, ${rn(rt)}` : `${m('addu')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x22: return `${m('sub')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x23: return `${m('subu')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x24: return `${m('and')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x25: return rs===0&&rt===0 ? `${p('clear')} ${rn(rd)}` : rs===0 ? `${p('move')} ${rn(rd)}, ${rn(rt)}` : `${m('or')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x26: return `${m('xor')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x27: return rs===0 ? `${p('not')} ${rn(rd)}, ${rn(rt)}` : `${m('nor')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x2A: return `${m('slt')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x2B: return `${m('sltu')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x2C: return `${m('dadd')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x2D: return `${m('daddu')} ${rn(rd)}, ${rn(rs)}, ${rn(rt)}`;
      case 0x38: return `${m('dsll')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
      case 0x3A: return `${m('dsrl')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
      case 0x3B: return `${m('dsra')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
      case 0x3C: return `${m('dsll32')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
      case 0x3E: return `${m('dsrl32')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
      case 0x3F: return `${m('dsra32')} ${rn(rd)}, ${rn(rt)}, ${hi(sa,false)}`;
    }
    return null;
  }
  if (op===1){const b={0:'bltz',1:'bgez',2:'bltzl',3:'bgezl',0x10:'bltzal',0x11:'bgezal'};return b[rt]?`${m(b[rt])} ${rn(rs)}, ${brt(imm,pc)}`:null;}
  if (op===0x10){if(rs===0)return`${m('mfc0')} ${rn(rt)}, <span class="rg">c${rd}</span>`;if(rs===4)return`${m('mtc0')} ${rn(rt)}, <span class="rg">c${rd}</span>`;if(rs===0x10&&fn===0x18)return m('eret');return null;}
  if (op===0x11){
    if(rs===0x00)return`${m('mfc1')} ${rn(rt)}, ${frn(rd)}`;
    if(rs===0x04)return`${m('mtc1')} ${rn(rt)}, ${frn(rd)}`;
    if(rs===0x08){const bc={0:'bc1f',1:'bc1t',2:'bc1fl',3:'bc1tl'};return bc[rt]?`${m(bc[rt])} ${brt(imm,pc)}`:null;}
    const fN={0x10:'s',0x11:'d',0x14:'w',0x15:'l'},fmt=fN[rs];
    if(fmt){const fo={0x00:'add',0x01:'sub',0x02:'mul',0x03:'div',0x04:'sqrt',0x05:'abs',0x06:'mov',0x07:'neg',0x0C:'round.w',0x0D:'trunc.w',0x20:'cvt.s',0x21:'cvt.d',0x24:'cvt.w',0x30:'c.f',0x32:'c.eq',0x34:'c.olt',0x3C:'c.lt',0x3E:'c.le'};const fn2=fo[fn];if(fn2){const fd=(word>>6)&0x1F,fs=(word>>11)&0x1F,ft2=(word>>16)&0x1F;return`${m(fn2+'.'+fmt)} ${frn(fd)}, ${frn(fs)}, ${frn(ft2)}`;}}
    return null;
  }
  switch(op){
    case 0x02:return`${m('j')} ${j26(word,pc)}`;
    case 0x03:return`${m('jal')} ${j26(word,pc)}`;
    case 0x04:return rs===rt?`${p('b')} ${brt(imm,pc)}`:`${m('beq')} ${rn(rs)}, ${rn(rt)}, ${brt(imm,pc)}`;
    case 0x05:return`${m('bne')} ${rn(rs)}, ${rn(rt)}, ${brt(imm,pc)}`;
    case 0x06:return`${m('blez')} ${rn(rs)}, ${brt(imm,pc)}`;
    case 0x07:return`${m('bgtz')} ${rn(rs)}, ${brt(imm,pc)}`;
    case 0x08:return rs===0?`${p('li')} ${rn(rt)}, ${hi(imm)}`:`${m('addi')} ${rn(rt)}, ${rn(rs)}, ${hi(imm)}`;
    case 0x09:return rs===0?`${p('li')} ${rn(rt)}, ${hi(imm)}`:`${m('addiu')} ${rn(rt)}, ${rn(rs)}, ${hi(imm)}`;
    case 0x0A:return`${m('slti')} ${rn(rt)}, ${rn(rs)}, ${hi(imm)}`;
    case 0x0B:return`${m('sltiu')} ${rn(rt)}, ${rn(rs)}, ${hi(imm,false)}`;
    case 0x0C:return`${m('andi')} ${rn(rt)}, ${rn(rs)}, ${hi(imm,false)}`;
    case 0x0D:return`${m('ori')} ${rn(rt)}, ${rn(rs)}, ${hi(imm,false)}`;
    case 0x0E:return`${m('xori')} ${rn(rt)}, ${rn(rs)}, ${hi(imm,false)}`;
    case 0x0F:return`${m('lui')} ${rn(rt)}, ${hi(imm,false)}`;
    case 0x14:return`${m('beql')} ${rn(rs)}, ${rn(rt)}, ${brt(imm,pc)}`;
    case 0x15:return`${m('bnel')} ${rn(rs)}, ${rn(rt)}, ${brt(imm,pc)}`;
    case 0x16:return`${m('blezl')} ${rn(rs)}, ${brt(imm,pc)}`;
    case 0x17:return`${m('bgtzl')} ${rn(rs)}, ${brt(imm,pc)}`;
    case 0x18:return`${m('daddi')} ${rn(rt)}, ${rn(rs)}, ${hi(imm)}`;
    case 0x19:return`${m('daddiu')} ${rn(rt)}, ${rn(rs)}, ${hi(imm)}`;
    case 0x20:return`${m('lb')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x21:return`${m('lh')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x22:return`${m('lwl')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x23:return`${m('lw')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x24:return`${m('lbu')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x25:return`${m('lhu')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x26:return`${m('lwr')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x27:return`${m('lwu')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x28:return`${m('sb')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x29:return`${m('sh')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x2A:return`${m('swl')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x2B:return`${m('sw')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x2C:return`${m('sdl')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x2D:return`${m('sdr')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x2E:return`${m('swr')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x2F:return`${m('cache')} ${hi(rt,false)}, ${hi(imm)}(${rn(rs)})`;
    case 0x30:return`${m('ll')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x31:return`${m('lwc1')} ${frn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x35:return`${m('ldc1')} ${frn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x37:return`${m('ld')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x38:return`${m('sc')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x39:return`${m('swc1')} ${frn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x3D:return`${m('sdc1')} ${frn(rt)}, ${hi(imm)}(${rn(rs)})`;
    case 0x3F:return`${m('sd')} ${rn(rt)}, ${hi(imm)}(${rn(rs)})`;
  }
  return null;
}

// ─────────────────────────── HELPERS ─────────────────────────
function hexToWords(s) {
  const c = s.replace(/0x/gi,'').replace(/[^0-9a-fA-F]/g,'');
  const w = [];
  for (let i = 0; i + 8 <= c.length; i += 8) w.push(parseInt(c.slice(i, i+8), 16));
  return w;
}

// Strip HTML tags → plain text of decoded instruction
function dwPlain(word, pc) {
  const r = dw(word, pc);
  return r ? r.replace(/<[^>]+>/g,'').replace(/\s+/g,' ').trim()
           : '; unknown: ' + word.toString(16).toUpperCase().padStart(8,'0');
}

// Flash a DOM element gold
function flash(el) { el.classList.add('hi'); setTimeout(()=>el.classList.remove('hi'),1400); }

// ─────────────────────────── GLOBAL JUMP ─────────────────────
// Tries disasm view, then ASM editor (by line address)
function gotoAddr(addr) {
  const hex = (addr>>>0).toString(16).toUpperCase().padStart(8,'0');
  // 1. disasm view rows (id = drow-XXXXXXXX)
  const drow = document.getElementById('drow-' + hex);
  if (drow) { switchTab('disasm'); drow.scrollIntoView({behavior:'smooth',block:'center'}); flash(drow); return; }
  // 2. ASM editor — walk lines to find matching virtual address
  _asmScrollToAddr(addr>>>0);
}

function _asmScrollToAddr(targetAddr) {
  const base = parseInt(document.getElementById('asmBase').value.replace(/0x/i,''),16) || 0;
  const lines = document.getElementById('asmIn').value.split('\n');
  let pc = base, lineIdx = -1;
  for (let i = 0; i < lines.length; i++) {
    const cl = lines[i].replace(/[;\/].*/,'').trim();
    if (cl) {
      if ((pc>>>0) === (targetAddr>>>0)) { lineIdx = i; break; }
      pc = (pc+4)>>>0;
    }
  }
  if (lineIdx < 0) { toast('0x' + targetAddr.toString(16).toUpperCase() + ' not in current view'); return; }
  switchTab('asmEdit');
  const ta = document.getElementById('asmIn');
  ta.scrollTop = lineIdx * LINE_H - ta.clientHeight / 2;
  // highlight gutter line
  const gl = document.getElementById('asmGutter').children[lineIdx];
  if (gl) { gl.style.background='rgba(201,147,90,0.22)'; setTimeout(()=>gl.style.background='',1400); }
}

// ─────────────────────────── TAB 1: HEX → ASM ────────────────
function disassemble() {
  const base = parseInt(document.getElementById('baseAddr').value.replace(/0x/i,''),16) || 0x80246000;
  const words = hexToWords(document.getElementById('hexInput').value);
  const out = document.getElementById('disasmOut');
  if (!words.length) {
    out.innerHTML = `<div class="err" style="padding:16px;font-style:italic;font-family:'IM Fell English',serif">// no valid hex data.</div>`;
    document.getElementById('dStats').style.display = 'none';
    return;
  }
  lastWords = words; lastBase = base;
  let html='', ec=0, bc=0;
  words.forEach((word, i) => {
    const pc = (base + i*4) >>> 0;
    const as = pc.toString(16).toUpperCase().padStart(8,'0');
    const hs = word.toString(16).toUpperCase().padStart(8,'0');
    let asm = dw(word, pc);
    const op = (word>>>26)&0x3F;
    if ([2,3,4,5,6,7,0x14,0x15,0x16,0x17].includes(op)||(op===0&&[8,9].includes(word&0x3F))||op===1) bc++;
    if (asm===null){asm=`<span class="err">/* unknown: ${hs} */</span>`;ec++;}
    const fnE = functions.find(f=>f.addr===pc);
    if (fnE) html+=`<div class="fn-label-row">✦ ${fnE.name}</div>`;
    html+=`<div class="irow" id="drow-${as}"><span class="addr-c click" onclick="gotoAddr(0x${as})">${as}:</span><span class="hcol">${hs}</span><span class="acol">${asm}</span></div>`;
  });
  out.innerHTML = html;
  document.getElementById('dStats').style.display = 'flex';
  document.getElementById('sCnt').textContent = words.length;
  document.getElementById('sErr').textContent = ec;
  document.getElementById('sBr').textContent  = bc;
}

function clearDisasm() {
  document.getElementById('hexInput').value = '';
  document.getElementById('disasmOut').innerHTML = `<div style="padding:28px 14px;color:var(--dim);font-size:14px;font-style:italic;font-family:'IM Fell English',serif">// cleared.</div>`;
  document.getElementById('dStats').style.display = 'none';
}

function disasmJump() {
  const v = document.getElementById('d_jumpIn').value;
  const addr = parseInt(v.replace(/0x/i,''),16);
  if (isNaN(addr)) { toast('invalid address'); return; }
  gotoAddr(addr);
}

// Push plain-text decoded assembly to ASM Editor
function pushToAsmEditor() {
  if (!lastWords.length) { toast('nothing decoded yet'); return; }
  const lines = lastWords.map((w,i) => dwPlain(w, (lastBase+i*4)>>>0));
  document.getElementById('asmIn').value = lines.join('\n');
  document.getElementById('asmBase').value = lastBase.toString(16).toUpperCase();
  updateGutter();
  switchTab('asmEdit');
  toast('sent to ASM editor');
}

const EXMAP = {
  prologue:'27BDFFE0 AFBF001C AFBE0018 AFB70014 AFB60010 AFB50014 AFB40010 AFB3000C AFB20008 AFB10004 AFB00000 03A0F025',
  branch:  '8C820000 10400008 00000000 24420001 2C430010 1460FFFA 00000000 03E00008 00000000',
  mario:   '3C018016 8C22A5D0 14400005 00000000 3C018016 8C22A5C8 3C038016 8C63A5D0 00431821 AC62A5D0 03E00008 00000000'
};
function loadEx(k){document.getElementById('hexInput').value=EXMAP[k];disassemble();}
document.getElementById('hexInput').addEventListener('paste',()=>setTimeout(disassemble,60));

// ─────────────────────────── TAB 2: ROM LOADER ───────────────
function handleRomDrop(e) {
  e.preventDefault();
  document.getElementById('dropZone').classList.remove('drag');
  if (e.dataTransfer.files[0]) loadRomFile(e.dataTransfer.files[0]);
}

function loadRomFile(file) {
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => {
    romData = new Uint8Array(ev.target.result);
    const magic = ((romData[0]<<24)|(romData[1]<<16)|(romData[2]<<8)|romData[3])>>>0;
    let fmt='Unknown';
    if (magic===0x80371240) fmt='Z64 (Big-endian)';
    else if (magic===0x37804012){fmt='V64 → normalized';for(let i=0;i<romData.length-1;i+=2){const t=romData[i];romData[i]=romData[i+1];romData[i+1]=t;}}
    else if (magic===0x40123780){fmt='N64 → normalized';for(let i=0;i<romData.length-3;i+=4){const a=romData[i],b=romData[i+1];romData[i]=romData[i+3];romData[i+1]=romData[i+2];romData[i+2]=b;romData[i+3]=a;}}
    const crc1=((romData[0x10]<<24)|(romData[0x11]<<16)|(romData[0x12]<<8)|romData[0x13])>>>0;
    const crc2=((romData[0x14]<<24)|(romData[0x15]<<16)|(romData[0x16]<<8)|romData[0x17])>>>0;
    let title='';for(let i=0x20;i<0x34;i++){const c=romData[i];if(c>0x1f&&c<0x7f)title+=String.fromCharCode(c);}
    document.getElementById('ri-name').textContent=file.name;
    document.getElementById('ri-size').textContent=(romData.length/1048576).toFixed(2)+' MB';
    document.getElementById('ri-fmt').textContent=fmt;
    document.getElementById('ri-crc1').textContent=crc1.toString(16).toUpperCase().padStart(8,'0');
    document.getElementById('ri-crc2').textContent=crc2.toString(16).toUpperCase().padStart(8,'0');
    document.getElementById('ri-title').textContent=title.trim();
    document.getElementById('romInfoBar').style.display='grid';
    document.getElementById('romGoBar').style.display='flex';
    document.getElementById('dropZone').style.display='none';
    document.getElementById('romStatus').textContent='ROM: '+file.name;
    document.getElementById('romStatus').className='rom-status loaded';
    // ── AUTO-LOAD default section into BOTH editors ──
    _loadSection(
      parseInt(document.getElementById('romOffset').value,16)||0x1000,
      parseInt(document.getElementById('romLen').value,16)||0x200,
      parseInt(document.getElementById('romVaddr').value,16)||0x80246000
    );
    toast('ROM loaded: '+file.name);
  };
  r.readAsArrayBuffer(file);
}

function romLoadSection() {
  if (!romData){toast('no ROM loaded');return;}
  _loadSection(
    parseInt(document.getElementById('romOffset').value,16)||0x1000,
    parseInt(document.getElementById('romLen').value,16)||0x200,
    parseInt(document.getElementById('romVaddr').value,16)||0x80246000
  );
}

function _loadSection(off, len, va) {
  const slice = romData.slice(off, off+len);

  // ── Hex editor ──
  hexBytes = Array.from(slice);
  hexSelSt=hexSelEn=hexSelAnc=-1;
  renderHex();

  // ── ASM editor ──
  const words=[];
  for(let i=0;i+3<slice.length;i+=4)
    words.push(((slice[i]<<24)|(slice[i+1]<<16)|(slice[i+2]<<8)|slice[i+3])>>>0);
  lastWords=words; lastBase=va;
  const lines=words.map((w,i)=>dwPlain(w,(va+i*4)>>>0));
  document.getElementById('asmIn').value=lines.join('\n');
  document.getElementById('asmBase').value=va.toString(16).toUpperCase();
  updateGutter();

  toast(`section 0x${off.toString(16).toUpperCase()} (${len} bytes, vaddr 0x${va.toString(16).toUpperCase()}) → both editors`);
}

function romLoadFullHex() {
  if(!romData){toast('no ROM loaded');return;}
  hexBytes=Array.from(romData);
  hexSelSt=hexSelEn=hexSelAnc=-1;
  renderHex();switchTab('hexEdit');
  toast(`full ROM (${hexBytes.length.toLocaleString()} bytes) → hex editor`);
}

// ─────────────────────────── TAB 3: ASM EDITOR ───────────────
// The gutter shows virtual addresses, one per non-empty line.
// Blank/comment-only lines get a dim dot. Gutter is NOT editable.

function updateGutter() {
  const lines = document.getElementById('asmIn').value.split('\n');
  const base  = parseInt(document.getElementById('asmBase').value.replace(/0x/i,''),16) || 0;
  let html = '', pc = base;
  lines.forEach(line => {
    const cl = line.replace(/[;\/].*/,'').trim();
    if (!cl) {
      html += `<div class="asm-gl empty">·</div>`;
    } else {
      const as = pc.toString(16).toUpperCase().padStart(8,'0');
      const isFn = !!functions.find(f=>f.addr===pc);
      html += `<div class="asm-gl${isFn?' fnmark':''}" title="0x${as}">${as}:</div>`;
      pc = (pc+4)>>>0;
    }
  });
  document.getElementById('asmGutter').innerHTML = html;
  syncGutter();
}

function syncGutter() {
  const ta = document.getElementById('asmIn');
  document.getElementById('asmGutter').scrollTop = ta.scrollTop;
}
document.getElementById('asmIn').addEventListener('scroll', syncGutter);

function asmJump() {
  const v = document.getElementById('a_jumpIn').value;
  const addr = parseInt(v.replace(/0x/i,''),16);
  if (isNaN(addr)) { toast('invalid address'); return; }
  gotoAddr(addr);
}

// ── Mini assembler (one line → 32-bit word) ──
function pr(s){s=s.replace(/,/g,'').trim();const v=RMAP[s];return v!==undefined?v:/^r?\d+$/.test(s)?parseInt(s.replace('r','')):0;}
function pi(s){s=s.replace(/,/g,'').trim();return s.startsWith('0x')||s.startsWith('-0x')?parseInt(s,16):parseInt(s,10);}

function asm1(line,pc){
  line=line.replace(/[;\/].*/,'').trim();if(!line)return null;
  const t=line.split(/[\s,]+/).filter(Boolean);const op=t[0].toLowerCase();
  const E=w=>w>>>0,reg=i=>pr(t[i]||'r0'),imm=i=>pi(t[i]||'0');
  if(op==='nop')return 0;
  if(op==='move')return E((0x25|(reg(1)<<11)|(reg(2)<<21)));
  if(op==='li'){const v=imm(2);return E((0x09|(reg(1)<<16))|(v&0xFFFF));}
  if(op==='b'){const off=(imm(1)-pc-4)/4;return E((0x04<<26)|(off&0xFFFF));}
  if(op==='not')return E((0x27|(reg(1)<<11)|(reg(2)<<16)));
  const Rt=(f,rd,rs,rt,sa=0)=>E((rs<<21)|(rt<<16)|(rd<<11)|(sa<<6)|f);
  const It=(o,rs,rt,i16)=>E((o<<26)|(rs<<21)|(rt<<16)|(i16&0xFFFF));
  const ROP={sll:0,srl:2,sra:3,sllv:4,srlv:6,srav:7,jr:8,jalr:9,mfhi:0x10,mthi:0x11,mflo:0x12,mtlo:0x13,mult:0x18,multu:0x19,div:0x1A,divu:0x1B,add:0x20,addu:0x21,sub:0x22,subu:0x23,and:0x24,or:0x25,xor:0x26,nor:0x27,slt:0x2A,sltu:0x2B};
  if(ROP[op]!==undefined){const f=ROP[op];if(op==='jr')return Rt(f,0,reg(1),0);if(op==='jalr')return t.length>=3?Rt(f,reg(1),reg(2),0):Rt(f,31,reg(1),0);if(op==='mfhi'||op==='mflo')return Rt(f,reg(1),0,0);if(op==='mthi'||op==='mtlo')return Rt(f,0,reg(1),0);if(op==='mult'||op==='multu'||op==='div'||op==='divu')return Rt(f,0,reg(1),reg(2));if(op==='sll'||op==='srl'||op==='sra')return Rt(f,reg(1),0,reg(2),imm(3));if(op==='sllv'||op==='srlv'||op==='srav')return Rt(f,reg(1),reg(3),reg(2));return Rt(f,reg(1),reg(2),reg(3));}
  const IOP={addi:8,addiu:9,slti:0xA,sltiu:0xB,andi:0xC,ori:0xD,xori:0xE,lui:0xF,beq:4,bne:5,blez:6,bgtz:7,beql:0x14,bnel:0x15,blezl:0x16,bgtzl:0x17,daddi:0x18,daddiu:0x19,lb:0x20,lh:0x21,lwl:0x22,lw:0x23,lbu:0x24,lhu:0x25,lwr:0x26,lwu:0x27,sb:0x28,sh:0x29,swl:0x2A,sw:0x2B,sdl:0x2C,sdr:0x2D,swr:0x2E,ll:0x30,ld:0x37,sc:0x38,sd:0x3F,lwc1:0x31,ldc1:0x35,swc1:0x39,sdc1:0x3D};
  if(IOP[op]!==undefined){const o=IOP[op];if(op==='lui')return It(o,0,reg(1),imm(2));if(['beq','bne','beql','bnel'].includes(op))return It(o,reg(1),reg(2),(imm(3)-pc-4)/4);if(['blez','bgtz','blezl','bgtzl'].includes(op))return It(o,reg(1),0,(imm(2)-pc-4)/4);const last=t[t.length-1];if(last&&last.includes('(')){const mm=last.match(/(-?0?x?[0-9a-fA-F]+)\((\w+)\)/);if(mm)return It(o,pr(mm[2]),reg(1),pi(mm[1]));}return It(o,reg(1),reg(2),imm(3));}
  if(op==='j')return E((0x02<<26)|((imm(1)>>>2)&0x3FFFFFF));
  if(op==='jal')return E((0x03<<26)|((imm(1)>>>2)&0x3FFFFFF));
  if(op==='bltz')return E((0x01<<26)|(reg(1)<<21)|((imm(2)-pc-4)/4&0xFFFF));
  if(op==='bgez')return E((0x01<<26)|(reg(1)<<21)|(0x01<<16)|((imm(2)-pc-4)/4&0xFFFF));
  if(op==='syscall')return 0x0C;if(op==='break')return 0x0D;if(op==='sync')return 0x0F;
  return null;
}

function asmAssemble() {
  const lines=document.getElementById('asmIn').value.split('\n');
  const base=parseInt(document.getElementById('asmBase').value.replace(/0x/i,''),16)||0x80246000;
  let html='',words=[],pc=base,ok=0,ec=0;
  lines.forEach(line=>{
    const cl=line.replace(/[;\/].*/,'').trim();
    if(!cl){html+=`<div style="height:${LINE_H}px"></div>`;return;}
    const w=asm1(cl,pc);
    const as=pc.toString(16).toUpperCase().padStart(8,'0');
    if(w===null){html+=`<div class="irow"><span class="addr-c">${as}:</span><span class="hcol">????????</span><span class="acol err">/* error */</span></div>`;ec++;pc=(pc+4)>>>0;words.push(0);}
    else{const hs=w.toString(16).toUpperCase().padStart(8,'0');const a=dw(w,pc)||`<span class="cmt">/* ${hs} */</span>`;html+=`<div class="irow"><span class="addr-c">${as}:</span><span class="hcol">${hs}</span><span class="acol">${a}</span></div>`;words.push(w);ok++;pc=(pc+4)>>>0;}
  });
  const panel=document.getElementById('asmOutPanel');
  const out=document.getElementById('asmOut');
  out.innerHTML=html||'<div style="padding:10px 14px;color:var(--dim)">// empty</div>';
  out._w=words; panel.style.display='block';
  const st=document.getElementById('asmStat');
  st.textContent=`${ok} ok · ${ec} errors`;
  st.style.color=ec>0?'var(--rose)':'var(--sage2)';
}

function asmCopyHex(){
  const w=document.getElementById('asmOut')._w;
  if(!w||!w.length){toast('assemble first');return;}
  navigator.clipboard.writeText(w.map(x=>x.toString(16).toUpperCase().padStart(8,'0')).join(' ')).then(()=>toast('hex copied!')).catch(()=>toast('failed'));
}
function asmPushToHex(){
  const w=document.getElementById('asmOut')._w;
  if(!w||!w.length){toast('assemble first');return;}
  hexBytes=[];w.forEach(x=>{hexBytes.push((x>>>24)&0xFF,(x>>>16)&0xFF,(x>>>8)&0xFF,x&0xFF);});
  hexSelSt=hexSelEn=hexSelAnc=-1;renderHex();switchTab('hexEdit');toast('pushed to hex editor');
}

// init gutter
updateGutter();

// ─────────────────────────── TAB 4: HEX EDITOR ───────────────
const getSel=()=>(hexSelSt<0||hexSelEn<0)?null:{lo:Math.min(hexSelSt,hexSelEn),hi:Math.max(hexSelSt,hexSelEn)};

function renderHex(){
  const sc=document.getElementById('hexScroll');
  if(!hexBytes.length){sc.innerHTML='<div style="padding:28px 14px;color:var(--dim);font-size:14px;font-style:italic;font-family:\'IM Fell English\',serif">// empty</div>';updHxSt();return;}
  const sel=getSel();
  const rows=Math.ceil(hexBytes.length/HEX_COLS);
  let html='';
  for(let r=0;r<rows;r++){
    const ro=r*HEX_COLS;
    const offs=ro.toString(16).toUpperCase().padStart(8,'0');
    let cells='',asc='';
    for(let c=0;c<HEX_COLS;c++){
      const idx=ro+c;
      if(idx>=hexBytes.length){cells+=`<span class="hx-cell" style="opacity:0;pointer-events:none">--</span>`;asc+=`<span class="hx-ac" style="opacity:0">.</span>`;}
      else{
        const b=hexBytes[idx];
        const bh=b.toString(16).toUpperCase().padStart(2,'0');
        let cc='hx-cell';
        if(b===0)cc+=' nb';else if(b>=0x20&&b<0x7f)cc+=' pb';else if(b>=0x80)cc+=' hb';
        if(sel&&idx>=sel.lo&&idx<=sel.hi)cc+=' sel';
        if(idx===hexSelAnc)cc+=' sel-anc';
        const inSr=hexSrRes.some(s=>idx>=s&&idx<s+hexSrLen);
        const isCur=hexSrRes[hexSrIdx]!==undefined&&idx>=hexSrRes[hexSrIdx]&&idx<hexSrRes[hexSrIdx]+hexSrLen;
        if(isCur)cc+=' sc';else if(inSr)cc+=' sm';
        cells+=`<span class="${cc}" onclick="hxClick(event,${idx})">${bh}</span>`;
        let ac='hx-ac';
        if(b>=0x20&&b<0x7f)ac+=' ap';else if(b===0)ac+=' an';
        if(sel&&idx>=sel.lo&&idx<=sel.hi)ac+=' as';
        const ch=(b>=0x20&&b<0x7f)?(b===60?'&lt;':b===62?'&gt;':b===38?'&amp;':String.fromCharCode(b)):'.';
        asc+=`<span class="${ac}" onclick="hxClick(event,${idx})">${ch}</span>`;
      }
    }
    html+=`<div class="hx-row"><span class="hx-off">${offs}:</span><span class="hx-gap"></span>${cells}<span class="hx-gap2"></span><span class="hx-asc">${asc}</span></div>`;
  }
  sc.innerHTML=html;updHxSt();
  document.getElementById('hsSz').textContent=hexBytes.length.toLocaleString()+' bytes';
}

function hxClick(e,idx){
  if(e.shiftKey&&hexSelAnc>=0){hexSelSt=hexSelAnc;hexSelEn=idx;}
  else{hexSelAnc=idx;hexSelSt=idx;hexSelEn=idx;}
  renderHex();updHxSt();
  if(idx>=0&&idx<hexBytes.length)document.getElementById('h_patch').value=hexBytes[idx].toString(16).toUpperCase().padStart(2,'0');
}

function updHxSt(){
  const sel=getSel();
  document.getElementById('hsOff').textContent=hexSelAnc>=0?'0x'+hexSelAnc.toString(16).toUpperCase():'—';
  document.getElementById('hsVal').textContent=(hexSelAnc>=0&&hexSelAnc<hexBytes.length)?'0x'+hexBytes[hexSelAnc].toString(16).toUpperCase().padStart(2,'0'):'—';
  document.getElementById('hsSel').textContent=sel?`0x${sel.lo.toString(16).toUpperCase()}–0x${sel.hi.toString(16).toUpperCase()} (${sel.hi-sel.lo+1})`:'—';
}

function hexJump(){
  const off=parseInt(document.getElementById('h_jumpIn').value.replace(/0x/i,''),16);
  if(isNaN(off)||off<0||off>=hexBytes.length){toast('offset out of range');return;}
  const ri=Math.floor(off/HEX_COLS);
  const rows=document.getElementById('hexScroll').querySelectorAll('.hx-row');
  if(rows[ri])rows[ri].scrollIntoView({behavior:'smooth',block:'center'});
  hexSelAnc=off;hexSelSt=off;hexSelEn=off;renderHex();
}

function hexSelAll(){if(!hexBytes.length){toast('empty');return;}hexSelSt=0;hexSelEn=hexBytes.length-1;hexSelAnc=0;renderHex();}
function hexCopySel(){
  const sel=getSel();if(!sel){toast('no selection');return;}
  const h=hexBytes.slice(sel.lo,sel.hi+1).map(b=>b.toString(16).toUpperCase().padStart(2,'0')).join(' ');
  navigator.clipboard.writeText(h).then(()=>toast(`copied ${sel.hi-sel.lo+1} bytes`)).catch(()=>toast('failed'));
}
function hxBytes(s){const c=s.replace(/0x/gi,'').replace(/[^0-9a-fA-F]/g,'');if(!c.length)return null;const o=[];for(let i=0;i+1<c.length;i+=2)o.push(parseInt(c.slice(i,i+2),16));return o;}
function hexPasteOver(){const v=prompt('Paste hex bytes (overwrite at cursor):');if(!v)return;const b=hxBytes(v);if(!b){toast('invalid hex');return;}const st=hexSelAnc>=0?hexSelAnc:0;for(let i=0;i<b.length&&st+i<hexBytes.length;i++)hexBytes[st+i]=b[i];renderHex();toast(`pasted ${b.length} bytes at 0x${st.toString(16).toUpperCase()}`);}
function hexPasteIns(){const v=prompt('Paste hex bytes (insert at cursor):');if(!v)return;const b=hxBytes(v);if(!b){toast('invalid hex');return;}const st=hexSelAnc>=0?hexSelAnc:hexBytes.length;hexBytes.splice(st,0,...b);renderHex();toast(`inserted ${b.length} bytes at 0x${st.toString(16).toUpperCase()}`);}
function hexClear(){hexBytes=[];hexSelSt=hexSelEn=hexSelAnc=-1;hexSrRes=[];renderHex();document.getElementById('h_searchInfo').textContent='';}
function hexDisasm(){const sel=getSel();const b=sel?hexBytes.slice(sel.lo,sel.hi+1):hexBytes;if(!b.length){toast('nothing to disassemble');return;}document.getElementById('hexInput').value=b.map(x=>x.toString(16).toUpperCase().padStart(2,'0')).join('');switchTab('disasm');disassemble();}
function doPatch(){if(hexSelAnc<0||hexSelAnc>=hexBytes.length){toast('no byte selected');return;}const v=parseInt(document.getElementById('h_patch').value,16);if(isNaN(v)||v<0||v>255){toast('invalid byte');return;}hexBytes[hexSelAnc]=v;renderHex();toast(`patched 0x${hexSelAnc.toString(16).toUpperCase()} → 0x${v.toString(16).toUpperCase()}`);}
function loadHexRaw(){const b=hxBytes(document.getElementById('h_rawIn').value);if(!b){toast('invalid hex');return;}hexBytes=b;hexSelSt=hexSelEn=hexSelAnc=-1;document.getElementById('h_rawIn').value='';renderHex();toast(`loaded ${hexBytes.length} bytes`);}

function hexSearchNext(){
  const pat=hxBytes(document.getElementById('h_searchIn').value);
  if(!pat||!pat.length){toast('enter bytes to search');return;}
  hexSrLen=pat.length;hexSrRes=[];
  for(let i=0;i<=hexBytes.length-pat.length;i++){let ok=true;for(let j=0;j<pat.length;j++){if(hexBytes[i+j]!==pat[j]){ok=false;break;}}if(ok)hexSrRes.push(i);}
  if(!hexSrRes.length){toast('not found');document.getElementById('h_searchInfo').textContent='0 results';renderHex();return;}
  hexSrIdx=(hexSrIdx+1)%hexSrRes.length;_hexSrScroll();
}
function hexSearchPrev(){if(!hexSrRes.length){hexSearchNext();return;}hexSrIdx=(hexSrIdx-1+hexSrRes.length)%hexSrRes.length;_hexSrScroll();}
function _hexSrScroll(){
  const off=hexSrRes[hexSrIdx];document.getElementById('h_searchInfo').textContent=`${hexSrIdx+1}/${hexSrRes.length}`;
  hexSelAnc=off;hexSelSt=off;hexSelEn=off+hexSrLen-1;renderHex();
  const ri=Math.floor(off/HEX_COLS);const rows=document.getElementById('hexScroll').querySelectorAll('.hx-row');if(rows[ri])rows[ri].scrollIntoView({behavior:'smooth',block:'center'});
}

// keyboard nav
document.addEventListener('keydown',e=>{
  if(!document.getElementById('tab-hexEdit').classList.contains('active'))return;
  if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName))return;
  if(e.key==='ArrowRight'){e.preventDefault();hxMove(1,e.shiftKey);}
  else if(e.key==='ArrowLeft'){e.preventDefault();hxMove(-1,e.shiftKey);}
  else if(e.key==='ArrowDown'){e.preventDefault();hxMove(HEX_COLS,e.shiftKey);}
  else if(e.key==='ArrowUp'){e.preventDefault();hxMove(-HEX_COLS,e.shiftKey);}
  else if((e.ctrlKey||e.metaKey)&&e.key==='a'){e.preventDefault();hexSelAll();}
  else if((e.ctrlKey||e.metaKey)&&e.key==='c'){e.preventDefault();hexCopySel();}
});
function hxMove(d,sh){
  if(!hexBytes.length)return;
  const na=Math.max(0,Math.min(hexBytes.length-1,(hexSelAnc<0?0:hexSelAnc)+d));
  if(sh){if(hexSelSt<0)hexSelSt=na;hexSelEn=na;}else{hexSelSt=hexSelEn=na;}
  hexSelAnc=na;renderHex();
  const ri=Math.floor(na/HEX_COLS);const rows=document.getElementById('hexScroll').querySelectorAll('.hx-row');if(rows[ri])rows[ri].scrollIntoView({block:'nearest'});
}

// ─────────────────────────── TAB 5: FUNCTIONS ────────────────
function renderFns(){
  const q=(document.getElementById('fnSearch').value||'').toLowerCase();
  const lst=document.getElementById('fnList');
  const fil=functions.filter(f=>!q||f.name.toLowerCase().includes(q)||f.addr.toString(16).includes(q)||(f.cat&&f.cat.toLowerCase().includes(q)));
  document.getElementById('fnCount').textContent=`(${fil.length} of ${functions.length})`;
  if(!fil.length){lst.innerHTML='<div style="padding:18px 14px;color:var(--dim);font-size:13px;font-style:italic;font-family:\'IM Fell English\',serif">// no matches</div>';return;}
  const catC={'OBJECT':'var(--rose2)','BEHAVIOR':'var(--lavender)','MARIO':'var(--gold2)','INTERFACE':'var(--sage2)','SOUND':'#c4a8d8','MATH':'var(--blush)','MEMORY':'var(--muted2)'};
  lst.innerHTML=fil.map(f=>{
    const as=f.addr.toString(16).toUpperCase().padStart(8,'0');
    const fi=functions.indexOf(f);
    const cc=f.cat?(catC[f.cat]||'var(--muted)'):'';
    const cb=f.cat?`<span class="fn-cat-s" style="color:${cc};border-color:${cc}">${f.cat}</span>`:'';
    return `<div class="fn-row" onclick="goFn(${fi})" onmouseenter="showTip(event,0x${as})" onmouseleave="hideTip()">
      <span class="fn-addr-s">0x${as}</span>
      <span class="fn-name-s" title="${f.name}">${f.name}</span>
      ${cb}
      <span class="fn-del" onclick="event.stopPropagation();delFn(${fi})">×</span>
    </div>`;
  }).join('');
}

function goFn(idx){
  const f=functions[idx];if(!f)return;
  // jump in ASM editor to this virtual address
  gotoAddr(f.addr);
}

function addFn(){
  const addr=parseInt(document.getElementById('fnAddr').value.replace(/0x/i,''),16);
  const name=document.getElementById('fnName').value.trim()||`func_${addr.toString(16)}`;
  if(isNaN(addr)){toast('invalid address');return;}
  if(functions.find(f=>f.addr===addr)){toast('already exists');return;}
  functions.push({addr,name,desc:'',cat:'',builtin:false});
  functions.sort((a,b)=>a.addr-b.addr);
  document.getElementById('fnAddr').value='';document.getElementById('fnName').value='';
  renderFns();toast('added '+name);
}
function delFn(idx){functions.splice(idx,1);renderFns();}

function autoDetectFns(){
  if(!lastWords.length){toast('disassemble something first');return;}
  let n=0;
  lastWords.forEach((w,i)=>{
    if(((w>>>26)&0x3F)===0x03){
      const pc=(lastBase+i*4)>>>0;
      const t=((pc&0xF0000000)|((w&0x3FFFFFF)<<2))>>>0;
      if(!functions.find(f=>f.addr===t)){
        const kn=KNOWN[t>>>0];
        functions.push({addr:t,name:kn?kn.name:`func_${t.toString(16)}`,desc:kn?kn.args:'',cat:kn?kn.cat:'',builtin:!!kn});
        n++;
      }
    }
  });
  functions.sort((a,b)=>a.addr-b.addr);renderFns();toast(`detected ${n} new function(s)`);
}
function clearFns(){functions=[];renderFns();toast('cleared');}
function exportFns(){
  if(!functions.length){toast('no functions');return;}
  const txt=functions.map(f=>`0x${f.addr.toString(16).toUpperCase().padStart(8,'0')} ${f.name}`).join('\n');
  navigator.clipboard.writeText(txt).then(()=>toast('exported')).catch(()=>toast('failed'));
}

// ─────────────────────────── TOAST ───────────────────────────
let _ttimer=null;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  if(_ttimer)clearTimeout(_ttimer);
  _ttimer=setTimeout(()=>el.classList.remove('show'),2400);
}

// init
renderHex();
</script>
</body>
</html>